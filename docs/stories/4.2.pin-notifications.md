# Story 4.2: Pin Notification System

## Status
Draft

## Story
**As a** user,
**I want** notifications when leadership creates global pins,
**so that** I'm aware of important tasks that require my attention.

## Acceptance Criteria

1. Real-time notifications when global pins are created/removed
2. Notification shows pin creator, task title, and priority
3. Notifications respect user notification preferences
4. Email notifications for high-priority global pins (optional)
5. Notification history and management interface
6. Toast notifications with appropriate styling and actions

## Tasks / Subtasks

- [ ] Real-time Notification System (AC: 1)
  - [ ] Implement WebSocket/SSE for pin notifications
  - [ ] Create notification event handlers
  - [ ] Handle connection states and reconnection
  - [ ] Support batch notifications for bulk operations

- [ ] Notification Content Design (AC: 2)
  - [ ] Design notification message templates
  - [ ] Include relevant metadata (creator, priority, reason)
  - [ ] Add action buttons (view task, dismiss)
  - [ ] Support rich content (task previews, links)

- [ ] User Preference Integration (AC: 3)
  - [ ] Extend user preferences for pin notifications
  - [ ] Allow notification filtering by priority/department
  - [ ] Support do-not-disturb modes
  - [ ] Implement notification scheduling (work hours only)

- [ ] Email Notification Service (AC: 4)
  - [ ] Create email templates for pin notifications
  - [ ] Implement priority-based email triggers
  - [ ] Add unsubscribe functionality
  - [ ] Support email batching to prevent spam

- [ ] Notification Management UI (AC: 5, 6)
  - [ ] Create notification center/history view
  - [ ] Implement toast notification system
  - [ ] Add notification dismissal and archiving
  - [ ] Support notification actions (mark as read, etc.)

## Dev Notes

### Relevant Source Tree
- `src/services/notificationService.ts` - Core notification service
- `src/components/NotificationCenter.tsx` - Notification management UI
- `src/components/Toast.tsx` - Toast notification component
- `src/hooks/useNotifications.ts` - Notification state management
- `api/notifications.php` - Backend notification API

### Notification Event Types
```typescript
interface PinNotificationEvent {
  id: string;
  type: 'global_pin_created' | 'global_pin_removed' | 'global_pin_updated';
  data: {
    taskId: string;
    taskTitle: string;
    pinnedBy: string;
    pinnedByName: string;
    priority: number;
    reason?: string;
    timestamp: Date;
  };
  recipients: string[]; // User IDs to notify
}
```

### Real-time Notification Service
```typescript
class PinNotificationService {
  private eventSource: EventSource;
  private listeners: Map<string, Function[]> = new Map();

  connect() {
    this.eventSource = new EventSource('/api/notifications/stream');
    this.eventSource.onmessage = this.handleNotification.bind(this);
  }

  private handleNotification(event: MessageEvent) {
    const notification: PinNotificationEvent = JSON.parse(event.data);
    this.notifyListeners(notification);
  }

  subscribe(eventType: string, callback: Function) {
    if (!this.listeners.has(eventType)) {
      this.listeners.set(eventType, []);
    }
    this.listeners.get(eventType).push(callback);
  }
}
```

### Toast Notification Component
```typescript
interface ToastNotificationProps {
  notification: PinNotificationEvent;
  onDismiss: () => void;
  onAction: (action: string) => void;
}

export const PinNotificationToast: React.FC<ToastNotificationProps> = ({
  notification,
  onDismiss,
  onAction
}) => {
  const { type, data } = notification;

  const getToastConfig = () => {
    switch (type) {
      case 'global_pin_created':
        return {
          icon: <StarIcon className="text-blue-500" />,
          title: 'Task Pinned Globally',
          message: `${data.pinnedByName} pinned "${data.taskTitle}"`,
          priority: data.priority,
          actions: [
            { label: 'View Task', action: 'view' },
            { label: 'Dismiss', action: 'dismiss' }
          ]
        };
      // Other cases...
    }
  };

  return (
    <Toast config={getToastConfig()} />
  );
};
```

### User Preference Schema
```typescript
interface NotificationPreferences {
  pinNotifications: {
    enabled: boolean;
    globalPinsOnly: boolean;
    minimumPriority: number;
    emailEnabled: boolean;
    quietHours: {
      enabled: boolean;
      start: string; // "22:00"
      end: string;   // "08:00"
    };
    departments: string[]; // Only notify for specific departments
  };
}
```

### Email Notification Template
```typescript
interface EmailTemplate {
  subject: string;
  html: string;
  text: string;
}

const getGlobalPinEmailTemplate = (notification: PinNotificationEvent): EmailTemplate => {
  const { data } = notification;
  return {
    subject: `High Priority Task Pinned: ${data.taskTitle}`,
    html: `
      <h2>Task Pinned Globally</h2>
      <p><strong>${data.pinnedByName}</strong> has pinned a high-priority task:</p>
      <div style="border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px;">
        <h3>${data.taskTitle}</h3>
        <p><strong>Priority:</strong> ${data.priority}/10</p>
        ${data.reason ? `<p><strong>Reason:</strong> ${data.reason}</p>` : ''}
      </div>
      <a href="${process.env.APP_URL}/tasks/${data.taskId}">View Task</a>
    `,
    text: `${data.pinnedByName} has pinned "${data.taskTitle}" with priority ${data.priority}/10`
  };
};
```

### Notification Management Hooks
```typescript
export const usePinNotifications = () => {
  const [notifications, setNotifications] = useState<PinNotificationEvent[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);

  const markAsRead = useCallback((notificationId: string) => {
    setNotifications(prev =>
      prev.map(n => n.id === notificationId ? { ...n, read: true } : n)
    );
  }, []);

  const dismissNotification = useCallback((notificationId: string) => {
    setNotifications(prev => prev.filter(n => n.id !== notificationId));
  }, []);

  return {
    notifications,
    unreadCount,
    markAsRead,
    dismissNotification
  };
};
```

### Testing Standards
- Real-time notification delivery testing
- Email notification testing
- User preference integration testing
- Notification performance testing
- Cross-browser notification support testing
- Edge case testing (offline/online transitions)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-20 | 1.0 | Initial story creation | Winston (Architect) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by QA Agent after implementation review*