# Story 2.2: Add Permission-Aware Pin Actions

## Status
Draft

## Story
**As a** frontend user,
**I want** pin actions to respect my role permissions,
**so that** I can only perform authorized pin operations with clear feedback.

## Acceptance Criteria

1. Pin actions check user permissions before execution
2. Unauthorized actions show clear error messages
3. UI elements are disabled/hidden based on permissions
4. API errors are gracefully handled and displayed
5. User role changes update permissions in real-time
6. Optimistic updates rollback on permission errors

## Tasks / Subtasks

- [ ] Permission Validation Layer (AC: 1, 2)
  - [ ] Create permission validation hooks
  - [ ] Implement pre-action permission checks
  - [ ] Add role-based action filtering
  - [ ] Handle permission-denied scenarios

- [ ] UI Permission Integration (AC: 3)
  - [ ] Create useCanPin hook for permission checking
  - [ ] Conditionally render pin controls based on permissions
  - [ ] Show/hide global pin options for authorized users
  - [ ] Disable buttons for unauthorized actions

- [ ] Error Handling System (AC: 4, 6)
  - [ ] Create error handling utilities for pin operations
  - [ ] Implement toast notifications for permission errors
  - [ ] Add retry mechanisms for network failures
  - [ ] Rollback optimistic updates on errors

- [ ] Real-time Permission Updates (AC: 5)
  - [ ] Listen for user role changes
  - [ ] Update pin permissions when roles change
  - [ ] Refresh UI state on permission updates
  - [ ] Handle permission revocation gracefully

- [ ] Optimistic Update Management (AC: 6)
  - [ ] Implement optimistic pin state updates
  - [ ] Queue pending operations
  - [ ] Rollback on permission/network errors
  - [ ] Show loading states during operations

## Dev Notes

### Relevant Source Tree
- `src/hooks/usePermissions.ts` - Permission checking hooks
- `src/components/TaskCard.tsx` - Pin control UI
- `src/services/pinService.ts` - Pin API operations
- `src/utils/errorHandling.ts` - Error management utilities

### Permission Hooks
```typescript
// Permission checking hooks
export const useCanPin = () => {
  const { userPermissions } = usePinStore();

  return {
    canPinPersonally: true, // Always true for authenticated users
    canPinGlobally: userPermissions.canCreateGlobalPins,
    canUpdateGlobalPins: userPermissions.canUpdateGlobalPins,
    canDeleteGlobalPins: userPermissions.canDeleteGlobalPins
  };
};

export const useCanPinTask = (taskId: string) => {
  const { getPinType } = usePinStore();
  const permissions = useCanPin();
  const pinType = getPinType(taskId);

  return {
    canTogglePersonal: true,
    canToggleGlobal: permissions.canPinGlobally,
    canRemove: pinType === 'global' ? permissions.canDeleteGlobalPins : true
  };
};
```

### Error Handling Strategy
```typescript
interface PinOperationResult {
  success: boolean;
  error?: string;
  requiresRollback?: boolean;
}

const handlePinOperation = async (operation: () => Promise<void>): Promise<PinOperationResult> => {
  try {
    await operation();
    return { success: true };
  } catch (error) {
    if (error.status === 403) {
      return {
        success: false,
        error: 'You do not have permission to perform this action',
        requiresRollback: true
      };
    }
    // Handle other errors...
  }
};
```

### UI Integration Patterns
```typescript
// Conditional rendering based on permissions
const PinControls = ({ taskId }) => {
  const { canToggleGlobal, canTogglePersonal } = useCanPinTask(taskId);

  return (
    <div className="pin-controls">
      {canTogglePersonal && <PersonalPinButton taskId={taskId} />}
      {canToggleGlobal && <GlobalPinButton taskId={taskId} />}
    </div>
  );
};
```

### Testing Standards
- Permission hook testing with different roles
- UI rendering tests with various permission states
- Error handling scenario testing
- Optimistic update rollback testing
- Real-time permission change testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-20 | 1.0 | Initial story creation | Winston (Architect) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by QA Agent after implementation review*