# Story 2.3: Update Persistence Layer

## Status
Draft

## Story
**As a** application user,
**I want** my pin preferences to persist across sessions,
**so that** both personal and global pins are maintained and synchronized properly.

## Acceptance Criteria

1. Personal pins persist in localStorage across browser sessions
2. Global pins sync from server on application startup
3. Pin state migration handles upgrade from single-pin system
4. Offline pin changes sync when connection is restored
5. Multiple browser tabs stay synchronized
6. Pin data corruption is handled gracefully

## Tasks / Subtasks

- [ ] LocalStorage Enhancement (AC: 1, 3)
  - [ ] Update persist middleware for dual pin structure
  - [ ] Implement data migration from old pin format
  - [ ] Add versioning to stored pin data
  - [ ] Handle localStorage quota exceeded scenarios

- [ ] Server Synchronization (AC: 2, 4)
  - [ ] Implement global pin fetching on app startup
  - [ ] Create sync queue for offline pin operations
  - [ ] Add retry logic for failed sync operations
  - [ ] Handle sync conflicts between local and server state

- [ ] Cross-Tab Synchronization (AC: 5)
  - [ ] Implement BroadcastChannel for tab communication
  - [ ] Sync pin state changes across open tabs
  - [ ] Handle storage events for localStorage changes
  - [ ] Prevent duplicate API calls from multiple tabs

- [ ] Error Recovery (AC: 6)
  - [ ] Detect and handle corrupted pin data
  - [ ] Implement fallback to server state on corruption
  - [ ] Add data validation before persistence
  - [ ] Create repair mechanisms for partial data loss

- [ ] Performance Optimization (AC: 1, 2)
  - [ ] Debounce rapid pin state changes
  - [ ] Implement selective sync (only changed data)
  - [ ] Add caching layer for global pin metadata
  - [ ] Optimize storage operations for large pin sets

## Dev Notes

### Relevant Source Tree
- `src/store/appStore.ts` - Store with persist middleware
- `src/services/syncService.ts` - Cross-tab and server sync
- `src/utils/storage.ts` - Storage utilities and migration
- `src/services/pinService.ts` - API communication

### Data Migration Strategy
```typescript
interface StoredPinData {
  version: number;
  personalPins: string[];
  globalPins?: GlobalPin[];
  lastSync?: number;
}

const migratePinData = (stored: any): StoredPinData => {
  // Handle migration from v1 (single pinnedTaskIds array)
  if (!stored.version || stored.version === 1) {
    return {
      version: 2,
      personalPins: stored.pinnedTaskIds || [],
      globalPins: [],
      lastSync: Date.now()
    };
  }
  return stored;
};
```

### Sync Strategy
```typescript
interface SyncQueue {
  operations: PinOperation[];
  retryCount: number;
  lastAttempt: number;
}

interface PinOperation {
  type: 'create' | 'update' | 'delete';
  pinType: 'personal' | 'global';
  taskId: string;
  data?: any;
  timestamp: number;
}
```

### Cross-Tab Communication
```typescript
class PinSyncService {
  private channel = new BroadcastChannel('pin-sync');

  broadcastPinChange(change: PinChangeEvent) {
    this.channel.postMessage(change);
  }

  onPinChange(callback: (change: PinChangeEvent) => void) {
    this.channel.addEventListener('message', (event) => {
      callback(event.data);
    });
  }
}
```

### Error Recovery Mechanisms
- Checksum validation for stored data
- Automatic repair from server state
- User notification for data conflicts
- Manual sync trigger for edge cases

### Testing Standards
- Data migration testing from v1 to v2
- Cross-tab synchronization testing
- Offline/online sync testing
- Storage corruption simulation
- Performance testing with large pin datasets
- Browser compatibility testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-20 | 1.0 | Initial story creation | Winston (Architect) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by QA Agent after implementation review*