# Story 1.1: Extend Task Schema for Dual-Pin Support

## Status
Draft

## Story
**As a** system architect,
**I want** to extend the task database schema to support dual-tier pins,
**so that** the system can differentiate between personal and global pins with proper metadata.

## Acceptance Criteria

1. Task table includes new pin-related columns without breaking existing functionality
2. Pin metadata (type, pinnedBy, priority, reason) is properly stored and retrieved
3. Database migration runs successfully on existing data
4. API endpoints return pin data in expected format
5. Foreign key relationships maintain data integrity
6. Indexes are optimized for pin-based queries

## Tasks / Subtasks

- [ ] Database Schema Migration (AC: 1, 3)
  - [ ] Add `pin_type` ENUM column ('personal', 'global', NULL)
  - [ ] Add `pinned_by` VARCHAR column for user ID
  - [ ] Add `pinned_at` TIMESTAMP column
  - [ ] Add `pin_priority` INT column (1-10, NULL for personal pins)
  - [ ] Add `pin_reason` TEXT column (optional context)
  - [ ] Create migration script with rollback capability

- [ ] API Response Enhancement (AC: 4)
  - [ ] Update `tasks_simple.php` to include pin fields
  - [ ] Ensure backward compatibility with existing frontend
  - [ ] Add pin data validation in API responses

- [ ] Database Optimization (AC: 6)
  - [ ] Create composite index on (pin_type, pinned_at)
  - [ ] Create index on pinned_by for user queries
  - [ ] Analyze query performance impact

- [ ] Data Integrity (AC: 5)
  - [ ] Add constraint: pin_priority only for global pins
  - [ ] Add constraint: pinned_by must be valid user ID when pin_type is set
  - [ ] Create database triggers for data validation

## Dev Notes

### Relevant Source Tree
- `api/tasks_simple.php` - Main tasks API endpoint
- `database/` - Schema files and migrations
- `api/config.php` - Database configuration

### Migration Strategy
- Use ALTER TABLE statements to add columns
- Default values: pin_type=NULL, pinned_by=NULL for existing records
- Ensure zero downtime during migration

### Data Model
```sql
-- New columns to add to tasks table
ALTER TABLE tasks ADD COLUMN pin_type ENUM('personal', 'global') NULL;
ALTER TABLE tasks ADD COLUMN pinned_by VARCHAR(255) NULL;
ALTER TABLE tasks ADD COLUMN pinned_at TIMESTAMP NULL;
ALTER TABLE tasks ADD COLUMN pin_priority INT NULL CHECK (pin_priority BETWEEN 1 AND 10);
ALTER TABLE tasks ADD COLUMN pin_reason TEXT NULL;

-- Constraints
ALTER TABLE tasks ADD CONSTRAINT chk_pin_priority
  CHECK (pin_type = 'global' OR pin_priority IS NULL);
```

### Testing Standards
- Test migration on copy of production data
- Verify API backward compatibility
- Test constraint enforcement
- Performance test with large datasets

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-20 | 1.0 | Initial story creation | Winston (Architect) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by QA Agent after implementation review*