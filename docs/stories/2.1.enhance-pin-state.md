# Story 2.1: Enhance Pin State Management

## Status
Draft

## Story
**As a** frontend developer,
**I want** the Zustand store enhanced to handle dual-tier pins,
**so that** the application can manage both personal and global pins with proper state synchronization.

## Acceptance Criteria

1. Store structure supports both personal and global pin types
2. Pin state updates trigger proper re-renders in components
3. State persistence works for both pin types
4. Store actions handle pin conflicts (personal vs global)
5. State remains consistent during concurrent updates
6. Performance is maintained with large numbers of pins

## Tasks / Subtasks

- [ ] Store Structure Enhancement (AC: 1)
  - [ ] Extend PinState interface for dual pin types
  - [ ] Add GlobalPin interface with priority and metadata
  - [ ] Update UserPreferences to include global pin permissions
  - [ ] Migrate existing pinnedTaskIds to new structure

- [ ] Store Actions Implementation (AC: 2, 4)
  - [ ] Create togglePersonalPin(taskId) action
  - [ ] Create toggleGlobalPin(taskId, priority, reason) action
  - [ ] Create updateGlobalPin(taskId, updates) action
  - [ ] Create removeGlobalPin(taskId) action
  - [ ] Add conflict resolution logic

- [ ] State Persistence (AC: 3)
  - [ ] Update persist middleware for new pin structure
  - [ ] Separate global pins from personal pins in storage
  - [ ] Handle migration from old pin format
  - [ ] Ensure localStorage compatibility

- [ ] Computed State Selectors (AC: 5, 6)
  - [ ] Create getPinnedTasks selector with proper hierarchy
  - [ ] Create isTaskPinned selector for both pin types
  - [ ] Create getUserPinPermissions selector
  - [ ] Optimize selectors for performance

- [ ] State Synchronization (AC: 5)
  - [ ] Handle real-time global pin updates from API
  - [ ] Implement optimistic updates for pin operations
  - [ ] Add error handling for failed pin operations
  - [ ] Sync state on user role changes

## Dev Notes

### Relevant Source Tree
- `src/store/appStore.ts` - Main Zustand store
- `src/store/dashboardStore.ts` - Dashboard-specific state
- `src/types/` - TypeScript interfaces

### Enhanced Store Structure
```typescript
interface PinState {
  personalPins: string[];
  globalPins: GlobalPin[];
  userPermissions: PinPermissions;
  isLoading: boolean;
  error: string | null;
}

interface GlobalPin {
  taskId: string;
  pinnedBy: string;
  pinnedAt: Date;
  priority: number;
  reason?: string;
}

interface PinPermissions {
  canCreateGlobalPins: boolean;
  canUpdateGlobalPins: boolean;
  canDeleteGlobalPins: boolean;
}
```

### Store Actions
```typescript
interface PinActions {
  // Personal pins
  togglePersonalPin: (taskId: string) => void;

  // Global pins
  toggleGlobalPin: (taskId: string, priority: number, reason?: string) => Promise<void>;
  updateGlobalPin: (taskId: string, updates: Partial<GlobalPin>) => Promise<void>;
  removeGlobalPin: (taskId: string) => Promise<void>;

  // Utilities
  isTaskPinned: (taskId: string) => { personal: boolean; global: boolean };
  getPinType: (taskId: string) => PinType | null;
  canUserPinGlobally: () => boolean;
}
```

### Conflict Resolution Logic
- Global pins override personal pins visually
- Both can exist simultaneously in state
- UI shows the higher-priority pin type
- Personal pins remain user-controllable

### Testing Standards
- Unit tests for each store action
- State persistence testing
- Concurrent update testing
- Performance testing with large pin sets
- Migration testing from old format

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-20 | 1.0 | Initial story creation | Winston (Architect) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by QA Agent after implementation review*