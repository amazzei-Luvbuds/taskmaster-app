<!DOCTYPE html>
<html>
<head>
   <base target="_top">
   <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
   <?!= include('style.css.html'); ?>
   <style>
           .kanban-header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 0; }
      .page-title { line-height:1.3; padding:4px 0 6px; margin:0; text-shadow:none; filter:none; position:static; }
      .kanban-controls select { background:#0f172a; color:#e5e7eb; border:1px solid #374151; padding:6px 8px; border-radius:6px; }
  </style>
</head>
<body>
   <div id="loader" class="loader">Loading Interactive Board...</div>
   
   <div class="app-container">
       <div class="kanban-header">
                       <h2 class="page-title">Project Kanban View</h2>
                       <div class="kanban-controls">
              <label for="kb-dept" style="margin-right:6px;">Department:</label>
              <select id="kb-dept"></select>
              <label for="kb-sort" style="margin:0 6px 0 12px;">Sort:</label>
              <select id="kb-sort">
                <option value="created_desc" selected>Newest first</option>
                <option value="created_asc">Oldest first</option>
              </select>
              <span style="margin-left:12px;"></span>
              <input id="nt-title" placeholder="New task title" style="background:#0f172a;color:#e5e7eb;border:1px solid #374151;padding:6px 8px;border-radius:6px;min-width:220px;">
              <select id="nt-owner" style="background:#0f172a;color:#e5e7eb;border:1px solid #374151;padding:6px 8px;border-radius:6px;"></select>
              <input id="nt-due" type="date" style="background:#0f172a;color:#e5e7eb;border:1px solid #374151;padding:6px 8px;border-radius:6px;">
              <button class="btn-small" onclick="createNewTask()">Create</button>
            </div>
       </div>
       <div id="tabs-container" class="tabs-container"></div>
       <div id="board-container" class="board-container"></div>
   </div>

   <!-- The Modal for Task Details -->
   <div id="details-modal" class="modal-overlay" style="display: none;">
       <div class="modal-content">
           <span class="modal-close" onclick="hideDetails()">√ó</span>
           <div id="modal-body">
               <!-- Content will be generated by JavaScript -->
           </div>
       </div>
   </div>

   <script>
               let fullData = { tasks: [], departments: [], users: [] };
        const statuses = ['Not Started', 'In Progress', 'Blocked', 'Completed'];
        let sortOrder = 'created_desc';
       let selectedDept = 'All';

       document.addEventListener('DOMContentLoaded', () => {
           // Try getKanbanData first, fallback to getTasks if it fails
           google.script.run
               .withSuccessHandler(function(data) {
                   if (data && data.tasks) {
                       // getKanbanData worked
                       initializeApp(data);
                   } else {
                       // getKanbanData failed, try getTasks as fallback
                       console.log('getKanbanData failed, trying getTasks fallback');
                       google.script.run
                           .withSuccessHandler(function(tasks) {
                               // Convert getTasks format to getKanbanData format
                               const fallbackData = {
                                   tasks: tasks,
                                   departments: [...new Set(tasks.map(t => t.department).filter(Boolean))].sort(),
                                   users: [...new Set(tasks.map(t => t.owners).filter(Boolean))].sort(),
                                   userRole: 'regular'
                               };
                               initializeApp(fallbackData);
                           })
                           .withFailureHandler(handleError)
                           .getTasks();
                   }
               })
               .withFailureHandler(function(error) {
                   console.log('getKanbanData failed with error:', error);
                   // Try getTasks as fallback
                   google.script.run
                       .withSuccessHandler(function(tasks) {
                           const fallbackData = {
                               tasks: tasks,
                               departments: [...new Set(tasks.map(t => t.department).filter(Boolean))].sort(),
                               users: [...new Set(tasks.map(t => t.owners).filter(Boolean))].sort(),
                               userRole: 'regular'
                           };
                           initializeApp(fallbackData);
                       })
                       .withFailureHandler(handleError)
                       .getTasks();
               })
               .getKanbanData();
           
           const sortSel = document.getElementById('kb-sort');
           sortSel.addEventListener('change', () => {
             sortOrder = sortSel.value;
           renderBoard(fullData.tasks);
          });
      });

      function populateNewTaskControls(){
        const ownerSel = document.getElementById('nt-owner');
        if (!ownerSel) return;
        ownerSel.innerHTML = '<option value="">Owner (optional)</option>';
        (fullData.users || []).forEach(u=>{ const o=document.createElement('option'); o.value=u; o.textContent=u; ownerSel.appendChild(o); });
      }

       function initializeApp(data) {
           if (!data || data.error) {
               handleError({ message: data ? data.error : "Failed to load initial data." });
               return;
           }
          fullData = data;
          renderTabs(data.departments);
          populateNewTaskControls();
          document.getElementById('loader').style.display = 'none';
      }

               function renderTabs(departments) {
            // Repurposed: populate department dropdown instead of tabs
            const sel = document.getElementById('kb-dept');
            if (!sel) return;
            sel.innerHTML = '';
            const optAll = document.createElement('option');
            optAll.value = 'All';
            optAll.textContent = 'All Departments';
            sel.appendChild(optAll);
            departments.forEach(dept => {
              const o = document.createElement('option');
              o.value = dept;
              o.textContent = dept;
              sel.appendChild(o);
            });
            sel.value = selectedDept;
            sel.onchange = () => { selectedDept = sel.value; renderBoard(fullData.tasks); };
            renderBoard(fullData.tasks);
        }
      
       function renderBoard(tasks) {
          const boardContainer = document.getElementById('board-container');
          boardContainer.innerHTML = '';

          // Filter out leadership tasks for regular users
          const nonLeadershipTasks = tasks.filter(t => !t.isLeadership);

                     // Filter by department if selected
           const base = (selectedDept && selectedDept !== 'All') ? nonLeadershipTasks.filter(t => t.department === selectedDept) : nonLeadershipTasks;
           // Sort by created date using selected order
           const sorted = base.slice().sort((a,b)=>{
             const ad = a.dateCreated ? new Date(a.dateCreated).getTime() : 0;
             const bd = b.dateCreated ? new Date(b.dateCreated).getTime() : 0;
             return sortOrder === 'created_asc' ? (ad - bd) : (bd - ad);
           });

          statuses.forEach(status => {
             const column = document.createElement('div');
             column.className = 'kanban-column';
             const tasksInColumn = sorted.filter(t => t.status === status);
             column.innerHTML = `<div class="column-title">${status} (${tasksInColumn.length})</div>
                                 <div class="card-container" data-status="${status}"></div>`;
             
             const cardContainer = column.querySelector('.card-container');
             tasksInColumn.forEach(task => {
                const card = document.createElement('div');
                card.className = 'kanban-card';
                card.dataset.taskId = task.taskID;
                card.onclick = () => showDetails(task.taskID);
                
                let dueDateHtml = '';
                if (task.dueDate) {
                    const dueDate = new Date(task.dueDate);
                    const isOverdue = dueDate < new Date() && task.status !== 'Completed';
                    dueDateHtml = `<span class="card-due-date ${isOverdue ? 'overdue' : ''}">üóìÔ∏è ${dueDate.toLocaleDateString()}</span>`;
                }

                // Generate owner avatars HTML
                let ownerAvatarsHtml = '';
                if (task.ownerDetails && task.ownerDetails.length > 0) {
                    ownerAvatarsHtml = task.ownerDetails.map(owner => 
                        `<img src="${owner.avatarUrl || 'https://i.imgur.com/Vues1gP.png'}" 
                             alt="${owner.fullName}" 
                             class="owner-avatar" 
                             title="${owner.fullName}"
                             onerror="this.src='https://i.imgur.com/Vues1gP.png'; this.onerror=null;">`
                    ).join('');
                } else {
                    ownerAvatarsHtml = '<span class="unassigned-text">Unassigned</span>';
                }

                // Generate status badge with proper class
                const statusClass = `status-${(task.status || '').toLowerCase().replace(' ', '-')}`;
                const statusBadge = `<span class="status-badge ${statusClass}">${task.status || 'N/A'}</span>`;

                card.innerHTML = `
                    <div class="card-title">${task.actionItem}</div>
                    <div class="card-footer">
                        <div class="card-id">${task.taskID}</div>
                        ${dueDateHtml}
                        <span class="card-created">${task.dateCreated ? new Date(task.dateCreated).toLocaleDateString() : ''}</span>
                        <div class="card-owner">
                            <div class="owner-avatars">${ownerAvatarsHtml}</div>
                        </div>
                        <div class="card-status">${statusBadge}</div>
                    </div>`;
                cardContainer.appendChild(card);
            });
            boardContainer.appendChild(column);
        });
        initializeDragAndDrop();
      }

      function createNewTask(){
        const title = (document.getElementById('nt-title').value || '').trim();
        const owner = document.getElementById('nt-owner').value || '';
        const due = document.getElementById('nt-due').value || '';
        const deptSel = document.getElementById('kb-dept');
        const dep = (deptSel && deptSel.value && deptSel.value!=='All') ? deptSel.value : (selectedDept!=='All'? selectedDept : 'General');
        if (!title){ alert('Enter a task title'); return; }
        const payload = { actionItem: title, owners: owner, dueDate: due, department: dep, status: 'Not Started' };
        document.getElementById('loader').style.display = 'flex';
        google.script.run
          .withSuccessHandler(function(res){
            document.getElementById('loader').style.display = 'none';
            if (!res || res.status !== 'Success'){ alert('Create failed: ' + (res && res.message ? res.message : 'Unknown')); return; }
            // Update UI in place
            const newTask = { taskID: res.taskID, actionItem: title, owners: owner, dueDate: due, department: dep, status: 'Not Started', dateCreated: new Date().toISOString() };
            fullData.tasks = Array.isArray(fullData.tasks) ? [newTask].concat(fullData.tasks) : [newTask];
            document.getElementById('nt-title').value = '';
            document.getElementById('nt-owner').value = '';
            document.getElementById('nt-due').value = '';
            renderBoard(fullData.tasks);
          })
          .withFailureHandler(function(err){ document.getElementById('loader').style.display = 'none'; alert('Create failed: ' + err.message); })
          .createSimpleTask(payload);
      }

      function showDetails(taskId) {
          const task = fullData.tasks.find(t => t.taskID === taskId);
          if (!task) return;

          const modalBody = document.getElementById('modal-body');
          
          let userOptions = fullData.users.map(user => 
              `<option value="${user}" ${task.owners === user ? 'selected' : ''}>${user}</option>`
          ).join('');

          const dueDateForInput = task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : '';

          modalBody.innerHTML = `
              <h2 class="modal-title">${task.actionItem}</h2>
              <div class="modal-form">
                  <div class="form-group">
                      <label for="assignee-select">Owner / Assignee</label>
                      <select id="assignee-select">${userOptions}</select>
                  </div>
                  <div class="form-group">
                      <label for="due-date-input">Due Date</label>
                      <input type="date" id="due-date-input" value="${dueDateForInput}">
                  </div>
                  <div class="form-group-inline">
                      <div class="form-group">
                          <label for="predicted-hours-input">Predicted Hours</label>
                          <input type="number" id="predicted-hours-input" value="${task.predictedHours || 0}">
                      </div>
                      <div class="form-group">
                          <label for="actual-hours-input">Actual Hours</label>
                          <input type="number" id="actual-hours-input" value="${task.actualHoursSpent || 0}">
                      </div>
                  </div>
                  <div class="form-actions">
                      <button id="save-btn" class="btn btn-primary interactive" onclick="saveTaskDetails('${task.taskID}')">Save Changes</button>
                  </div>
                  <div id="modal-status" class="modal-status"></div>
              </div>
          `;

          document.getElementById('details-modal').style.display = 'flex';
      }

      function hideDetails() {
          document.getElementById('details-modal').style.display = 'none';
      }

      function saveTaskDetails(taskId) {
          const saveBtn = document.getElementById('save-btn');
          const statusDiv = document.getElementById('modal-status');
          saveBtn.disabled = true;
          saveBtn.textContent = 'SAVING...';
          statusDiv.style.display = 'none';

          const updates = {
              owners: document.getElementById('assignee-select').value,
              dueDate: document.getElementById('due-date-input').value,
              predictedHours: document.getElementById('predicted-hours-input').value,
              actualHoursSpent: document.getElementById('actual-hours-input').value
          };

          google.script.run
              .withSuccessHandler(function(response) {
                  if (response.status === 'Success') {
                      const taskIndex = fullData.tasks.findIndex(t => t.taskID === taskId);
                      if (taskIndex > -1) {
                          const updatedTask = { ...fullData.tasks[taskIndex], ...updates };
                          fullData.tasks[taskIndex] = updatedTask;
                      }
                      const activeTab = document.querySelector('.tab.active');
                      if (activeTab) activeTab.click();
                      
                      statusDiv.textContent = 'Save successful!';
                      statusDiv.className = 'modal-status success';
                      statusDiv.style.display = 'block';

                      setTimeout(() => { hideDetails(); }, 1500);
                  } else {
                      handleError({ message: response.message });
                      saveBtn.disabled = false;
                      saveBtn.textContent = 'Save Changes';
                  }
              })
              .withFailureHandler(handleError)
              .updateTaskDetails(taskId, updates);
      }

      function initializeDragAndDrop() {
          const cardContainers = document.querySelectorAll('.card-container');
          cardContainers.forEach(container => {
              new Sortable(container, {
                  group: 'kanban',
                  animation: 150,
                  onEnd: function(evt) {
                      const taskId = evt.item.dataset.taskId;
                      const newStatus = evt.to.dataset.status;
                      document.getElementById('loader').style.display = 'flex';
                      google.script.run
                        .withSuccessHandler(function(response) {
                          const taskIndex = fullData.tasks.findIndex(t => t.taskID === taskId);
                          if (taskIndex > -1) {
                              fullData.tasks[taskIndex].status = newStatus;
                          }
                          const activeTab = document.querySelector('.tab.active');
                          if (activeTab) activeTab.click();
                          document.getElementById('loader').style.display = 'none';
                        })
                        .withFailureHandler(handleError)
                        .updateTaskStatus(taskId, newStatus);
                  }
              });
          });
      }

      function handleError(error) {
          const loader = document.getElementById('loader');
          loader.style.backgroundColor = 'rgba(220, 53, 69, 0.5)';
          loader.innerHTML = `<div class="error-message">An Error Occurred: ${error.message}</div>`;
      }
   </script>
</body>
</html>
